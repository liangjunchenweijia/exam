<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>题目录入 后台管理系统</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="stylesheet" href="../../../static/css/font.css">
		<link rel="stylesheet" href="../../../static/css/weadmin.css">
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
		<!--[if lt IE 9]>
	      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
	      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
	    <![endif]-->
		<style>
			.layui-form-label{
				width: 86px;
			}
			.layui-form-item .layui-input-inline{
				width: calc(100% - 126px);
			}
			.layui-textarea{
				min-height: 50px;
				margin-top: 10px;
			}
			.layui-tab{
				margin: 0;
			}
			.layui-tab-title{
				border: 0;
				margin-bottom: 20px;
			}
			.list{
				display: inline-table;
				width: 23%;
			}
			.list .layui-form-radio{
				margin: 0;
			}
			.list .layui-input{
				display: inline-block;
				width: calc(100% - 100px);
			}
            .part .fraction{
                position: absolute;
                top: 0;
                right: 10px;
                line-height: 38px;
            }
            .layui-field-title{
                position: relative;
            }
            .delPart{
                position: absolute;
                top: 0;
                right: 0;
                background: #FFFFFF;
                cursor: pointer;
                color: #FF5722;
            }
            .allInfo{
                position: fixed;
                right: 20px;
                top: 30px;
                background: #FFFFFF;
                line-height: 45px;
                z-index: 2;
            }
            .saveTest{
                position: fixed;
                left: 50%;
                bottom: 30px;
                z-index: 3;
            }
            .allInfo span{
                color: red;
            }
		</style>
	</head>

	<body>
		<div class="weadmin-body">
			<form class="layui-form">
				<fieldset class="layui-elem-field layui-field-title">
					<legend class="testPaperName" style="text-align: center;font-weight: bold;font-size: 36px;"></legend>
                    <legend class="allInfo">
                        共<span class="allTest">1</span>题,总分:<span class="allScore">0</span>
                    </legend>

				</fieldset>
                <div class="main_cont">
                    <div class="part">
                        <fieldset class="layui-elem-field layui-field-title" style="font-weight: bold;">
                            <legend>第<span class="orderNumber">1</span>题</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <label class="layui-form-label" style="font-weight: bold;">
                                <span class="we-red">*</span>题目名称
                            </label>
                            <div class="layui-input-inline">
                                <textarea lay-verify="required" placeholder="请输入题目" class="layui-textarea"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-inline">
                                <div class="layui-tab layui-tab-brief changeType" lay-filter="changeType">
                                    <ul class="layui-tab-title">
                                        <li class="layui-this" lay-id="1">选择题</li>
                                        <li lay-id="2">判断题</li>
                                    </ul>
                                    <div class="layui-tab-content">
                                        <div class="layui-tab-item layui-show">
                                            <div class="list">
                                                <input type="radio" name="objRadio" value="A" title="A" checked="">
                                                <input type="text" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">
                                            </div>
                                            <div class="list">
                                                <input type="radio" name="objRadio" value="B" title="B">
                                                <input type="text" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">
                                            </div>
                                            <div class="list">
                                                <input type="radio" name="objRadio" value="C" title="C">
                                                <input type="text" name="testPaperName" autocomplete="off" class="layui-input">
                                            </div>
                                            <div class="list">
                                                <input type="radio" name="objRadio" value="D" title="D">
                                                <input type="text" name="testPaperName" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                        <div class="layui-tab-item">
                                            <div class="list" style="width: 110px;line-height: 38px;">
                                                <input type="radio" name="objJudge" value="1" title="正确" checked="">
                                            </div>
                                            <div class="list" style="width: 110px;line-height: 38px;">
                                                <input type="radio" name="objJudge" value="0" title="错误">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                【正确答案】
                            </label>
                            <div class="layui-input-inline">
                                <label class="layui-form-label" style="text-align: left">
                                    <span class="answer">A</span>
                                </label>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                <span class="we-red">*</span>【分数】
                            </label>
                            <div class="layui-input-inline" style="width: 80px;">
                                <input type="text" name="fraction" lay-verify="number" maxlength="3" autocomplete="off" class="layui-input" style="text-align: right;padding-right: 30px;">
                                <span class="fraction">分</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <input id="dataId" name="testPaperNameId" type="hidden" value="4">
                    <button class="layui-btn layui-btn-normal" lay-filter="addExam" lay-submit="">+继续添加</button>
                    <button class="layui-btn saveTest" lay-filter="add" lay-submit="" style="margin-left: 20px;">保存试卷</button>
                </div>
			</form>
		</div>
		<script src="../../../static/lib/layui/layui.js" charset="utf-8"></script>
		
		<script>
			layui.extend({
				admin: '{/}../../../static/js/admin'
			});
			layui.use(['form', 'jquery','util','admin', 'layer','element'], function() {
				var form = layui.form,
					$ = layui.jquery,
					admin = layui.admin,
				    element = layui.element,
					layer = layui.layer;
				//页面初始化加载
				$(function(){
					setTimeout(function(){
						frameVal();
					},100);
				});
				function frameVal(){
					var dataId = $('input[name="testPaperNameId"]').val();
                    getInfo(dataId);
				};
				//查询试卷内容
				function getInfo(val){
                    $.ajax({
                        url: '/testPaper/queryTestPaperById',
                        type: "get",
                        data: {
                            id:val
                        },
                        dataType: "json",
                        contentType:'application/json;charset=utf-8',
                        success:function (res) {
                            if(res.success){
                                $('.testPaperName').html(res.obj[0].testPaperName);
                                var oThml = '';
                                if(res.obj[0].examTestPaperContentVOS.length>0){
                                    res.obj[0].examTestPaperContentVOS.map((item,index)=>{
                                        var title = item.title || '',
                                            optionA = item.optionA || '',
                                            optionB = item.optionB || '',
                                            optionC = item.optionC || '',
                                            optionD = item.optionD || '',
                                            type = item.type || '1',
                                            answer = item.answer || 'A',
                                            grade = item.grade || '';
                                        oThml += '<div class="part">'+
                                                    '<fieldset class="layui-elem-field layui-field-title">'+
                                                        '<legend style="font-weight: bold;">第<span class="orderNumber">'+Number(index+1)+'</span>题</legend>'+
                                                        '<legend class="delPart"><i class="layui-icon">&#xe640;</i>删除</legend>'+
                                                    '</fieldset>'+
                                                    '<div class="layui-form-item">'+
                                                        '<label class="layui-form-label" style="font-weight: bold;">'+
                                                            '<span class="we-red">*</span>题目名称'+
                                                        '</label>'+
                                                        '<div class="layui-input-inline">'+
                                                            '<textarea placeholder="请输入题目" lay-verify="required" class="layui-textarea">'+title+'</textarea>'+
                                                        '</div>'+
                                                    '</div>'+
                                                    '<div class="layui-form-item">'+
                                                        '<label class="layui-form-label"></label>'+
                                                        '<div class="layui-input-inline">'+
                                                            '<div class="layui-tab layui-tab-brief changeType" lay-filter="changeType">'+
                                                                '<ul class="layui-tab-title">'+
                                                                    '<li class="layui-this" lay-id="1">选择题</li>'+
                                                                    '<li lay-id="2">判断题</li>'+
                                                                '</ul>'+
                                                                '<div class="layui-tab-content">'+
                                                                    '<div class="layui-tab-item layui-show">'+
                                                                        '<div class="list">'+
                                                                            '<input type="radio" name="objRadio'+index+'" value="A" title="A" checked="">'+
                                                                            '<input type="text" value="'+optionA+'" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                                        '</div>'+
                                                                         '<div class="list">'+
                                                                            '<input type="radio" name="objRadio'+index+'" value="B" title="B">'+
                                                                            '<input type="text" value="'+optionB+'" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                                        '</div>'+
                                                                        '<div class="list">'+
                                                                            '<input type="radio" name="objRadio'+index+'" value="C" title="C">'+
                                                                            '<input type="text"  value="'+optionC+'" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                                        '</div>'+
                                                                        '<div class="list">'+
                                                                            '<input type="radio" name="objRadio'+index+'" value="D" title="D">'+
                                                                            '<input type="text" value="'+optionD+'" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                                        '</div>'+
                                                                    '</div>'+
                                                                    '<div class="layui-tab-item">'+
                                                                        '<div class="list" style="width: 110px;line-height: 38px;">'+
                                                                            '<input type="radio" name="objJudge'+index+'" value="1" title="正确" checked="">'+
                                                                        '</div>'+
                                                                        '<div class="list" style="width: 110px;line-height: 38px;">'+
                                                                            '<input type="radio" name="objJudge'+index+'" value="0" title="错误">'+
                                                                        '</div>'+
                                                                    '</div>'+
                                                                '</div>'+
                                                            '</div>'+
                                                        '</div>'+
                                                    '</div>'+
                                                    '<div class="layui-form-item">'+
                                                        '<label class="layui-form-label">【正确答案】</label>'+
                                                        '<div class="layui-input-inline">'+
                                                            '<label class="layui-form-label" style="text-align: left">'+
                                                                '<span class="answer">'+answer+'</span>'+
                                                            '</label>'+
                                                        '</div>'+
                                                    '</div>'+
                                                    '<div class="layui-form-item">'+
                                                        '<label class="layui-form-label">'+
                                                            '<span class="we-red">*</span>【分数】'+
                                                        '</label>'+
                                                        '<div class="layui-input-inline" style="width: 80px;">'+
                                                            '<input type="text" value="'+grade+'" name="fraction" lay-verify="number" maxlength="3" autocomplete="off" class="layui-input" style="text-align: right;padding-right: 30px;">'+
                                                            '<span class="fraction">分</span>'+
                                                        '</div>'+
                                                    '</div>'+
                                                '</div>';
                                    })
                                    $('.main_cont').empty().append(oThml);
                                    $('.allTest').html(res.obj[0].examTestPaperContentVOS.length);
                                    form.render();
                                    getAllScore();
                                }
                            }else{
                                layer.msg(res.errorMsg,{
                                    time: 1000
                                });
                            }
                        }
                    })
                };
                // 选择正确答案
                form.on('radio', function (data) {
                    var val = data.value;
                    if(val == 1){
                        val = "正确";
                    }else if(val == 0){
                        val = "错误";
                    }
                    $(this).parents('.part').find('.answer').html(val);
                    form.render();
                });
                //添加下一题
                form.on('submit(addExam)', function(data) {
                    var i = $('.part').length+1;
                    var oThml = '<div class="part">'+
                                    '<fieldset class="layui-elem-field layui-field-title">'+
                                        '<legend style="font-weight: bold;">第<span class="orderNumber">'+i+'</span>题</legend>'+
                                        '<legend class="delPart"><i class="layui-icon">&#xe640;</i>删除</legend>'+
                                    '</fieldset>'+
                                    '<div class="layui-form-item">'+
                                        '<label class="layui-form-label" style="font-weight: bold;">'+
                                            '<span class="we-red">*</span>题目名称'+
                                        '</label>'+
                                        '<div class="layui-input-inline">'+
                                            '<textarea placeholder="请输入题目" lay-verify="required" class="layui-textarea"></textarea>'+
                                        '</div>'+
                                    '</div>'+
                                    '<div class="layui-form-item">'+
                                        '<label class="layui-form-label"></label>'+
                                        '<div class="layui-input-inline">'+
                                            '<div class="layui-tab layui-tab-brief changeType" lay-filter="changeType">'+
                                                '<ul class="layui-tab-title">'+
                                                    '<li class="layui-this" lay-id="1">选择题</li>'+
                                                    '<li lay-id="2">判断题</li>'+
                                                '</ul>'+
                                                '<div class="layui-tab-content">'+
                                                    '<div class="layui-tab-item layui-show">'+
                                                        '<div class="list">'+
                                                            '<input type="radio" name="objRadio'+i+'" value="A" title="A" checked="">'+
                                                            '<input type="text" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                        '</div>'+
                                                        '<div class="list">'+
                                                            '<input type="radio" name="objRadio'+i+'" value="B" title="B">'+
                                                            '<input type="text" lay-verify="required" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                        '</div>'+
                                                        '<div class="list">'+
                                                            '<input type="radio" name="objRadio'+i+'" value="C" title="C">'+
                                                            '<input type="text" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                        '</div>'+
                                                        '<div class="list">'+
                                                            '<input type="radio" name="objRadio'+i+'" value="D" title="D">'+
                                                            '<input type="text" name="testPaperName" autocomplete="off" class="layui-input">'+
                                                        '</div>'+
                                                    '</div>'+
                                                    '<div class="layui-tab-item">'+
                                                        '<div class="list" style="width: 110px;line-height: 38px;">'+
                                                            '<input type="radio" name="objJudge'+i+'" value="1" title="正确" checked="">'+
                                                        '</div>'+
                                                        '<div class="list" style="width: 110px;line-height: 38px;">'+
                                                            '<input type="radio" name="objJudge'+i+'" value="0" title="错误">'+
                                                    '</div>'+
                                                '</div>'+
                                            '</div>'+
                                        '</div>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">【正确答案】</label>'+
                                    '<div class="layui-input-inline">'+
                                        '<label class="layui-form-label" style="text-align: left">'+
                                            '<span class="answer">A</span>'+
                                        '</label>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">'+
                                        '<span class="we-red">*</span>【分数】'+
                                    '</label>'+
                                    '<div class="layui-input-inline" style="width: 80px;">'+
                                        '<input type="text" name="fraction" lay-verify="number" maxlength="3" autocomplete="off" class="layui-input" style="text-align: right;padding-right: 30px;">'+
                                        '<span class="fraction">分</span>'+
                                    '</div>'+
                                '</div>'+
                            '</div>';
                    $('.main_cont').append(oThml);
                    $('.allTest').html(i);
                    form.render();
                    return false;
                });
                // 计算总分
                getAllScore();
                function getAllScore(){
                    var allScore = 0;
                    $('.part').each(function(){
                        allScore += Number($(this).find('input[name="fraction"]').val());
                    })
                    $('.allScore').html(allScore);
                }
                $(".layui-form").on("input","input[name='fraction']",function(){
                    getAllScore();
                });
                // 切换题目类型
                element.on('tab(changeType)', function(elem){
                    if( $(this).attr('lay-id') == 2 ){
                        $(this).parents('.part').find('input[name="testPaperName"]').attr('lay-verify','')
                    }else {
                        $(this).parents('.part').find('input[name="testPaperName"]').eq(0).attr('lay-verify','required')
                        $(this).parents('.part').find('input[name="testPaperName"]').eq(1).attr('lay-verify','required')
                    }
                    form.render();
                });
                // 删除题目
                $('body').on('click','.delPart',function () {
                    $(this).parents('.part').remove();
                    var onIndex = Number($(this).siblings().find('.orderNumber').html());
                    $('.part').each(function(){
                        var newIndex = Number($(this).find('.orderNumber').html())
                        if(newIndex>onIndex){
                            $(this).find('.orderNumber').html(newIndex-1);
                        }
                    })
                })
				//监听提交
				form.on('submit(add)', function(data) {
                    var datas = data.field;
                    var newArr = [];
                    $('.part').each(function(){
                        newArr.push({
                            "testPaperNameId":datas.testPaperNameId,
                            "title": $(this).find('.layui-textarea').val(),
                            "type":$(this).find('.layui-this').attr('lay-id'),
                            "optionA":$(this).find('input[name="testPaperName"]').eq(0).val(),
                            "optionB":$(this).find('input[name="testPaperName"]').eq(1).val(),
                            "optionC":$(this).find('input[name="testPaperName"]').eq(2).val(),
                            "optionD":$(this).find('input[name="testPaperName"]').eq(3).val(),
                            "grade":$(this).find('input[name="fraction"]').val(),
                            "answer":$(this).find('.answer').html()
                        })
                    });
					$.ajax({
						url: '/testPaper/saveTestPaperContent',
						data: JSON.stringify({
                            examTestPaperContentRequests:newArr
                        }),
						type: "POST",
						dataType: "json",
						contentType:'application/json;charset=utf-8',
						success:function (res) {
							if(res.success){
								layer.alert("增加成功", {
									icon: 6
								}, function() {
									var index = parent.layer.getFrameIndex(window.name);
									parent.location.reload();
									//关闭当前frame
									parent.layer.close(index);
								});
							}else{
								layer.msg(res.errorMsg,{
									time: 1000
								});
							}
						}
					})
					return false;
				});

			});
		</script>
	</body>

</html>